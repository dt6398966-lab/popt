<%- include('partials/header') %>

<section class="property-detail-page">
    <div class="container">
        <div class="property-detail-layout">
            <div class="property-main">
                <!-- Property Images -->
                <div class="property-images">
                    <div class="main-image">
                        <% if (property.images && property.images.length > 0) { %>
                            <img src="<%= property.images[0] %>" alt="<%= property.title %>" id="mainImage" style="width: 100%; height: 100%; object-fit: cover;">
                        <% } else { %>
                            <img src="https://via.placeholder.com/800x500/F97316/FFFFFF?text=No+Image+Available" alt="<%= property.title %>" id="mainImage" style="width: 100%; height: 100%; object-fit: cover;">
                        <% } %>
                        <% if (property.images && property.images.length > 1) { %>
                            <div class="image-counter">
                                <i class="fas fa-images"></i> <%= property.images.length %> Photos
                            </div>
                        <% } %>
                    </div>
                    <% if (property.images && property.images.length > 1) { %>
                        <div class="image-thumbnails">
                            <% property.images.forEach(function(image, index) { %>
                                <div class="thumbnail-wrapper <%= index === 0 ? 'active' : '' %>" onclick="changeImage('<%= image %>', <%= index %>)">
                                    <img src="<%= image %>" alt="Image <%= index + 1 %>">
                                </div>
                            <% }); %>
                        </div>
                    <% } %>
                </div>

                <!-- Property Details -->
                <div class="property-info">
                    <div class="property-header">
                        <h1><%= property.title %></h1>
                        <p class="property-location"><i class="fas fa-map-marker-alt"></i> <%= property.address %>, <%= property.city %>, <%= property.state %> - <%= property.pincode %></p>
                        <div class="property-price-large">
                            <span class="price">₹<%= parseFloat(property.price).toLocaleString('en-IN') %></span>
                            <span class="price-type"><%= property.transaction_type %></span>
                        </div>
                    </div>

                    <div class="property-specs-detail">
                        <h3>Property Details</h3>
                        <div class="specs-grid">
                            <div class="spec-item">
                                <i class="fas fa-vector-square"></i>
                                <div>
                                    <strong>Area</strong>
                                    <p><%= property.area %> sq.ft</p>
                                </div>
                            </div>
                            <% if (property.bedrooms > 0) { %>
                                <div class="spec-item">
                                    <i class="fas fa-bed"></i>
                                    <div>
                                        <strong>Bedrooms</strong>
                                        <p><%= property.bedrooms %> BHK</p>
                                    </div>
                                </div>
                            <% } %>
                            <% if (property.bathrooms > 0) { %>
                                <div class="spec-item">
                                    <i class="fas fa-bath"></i>
                                    <div>
                                        <strong>Bathrooms</strong>
                                        <p><%= property.bathrooms %></p>
                                    </div>
                                </div>
                            <% } %>
                            <% if (property.balconies > 0) { %>
                                <div class="spec-item">
                                    <i class="fas fa-door-open"></i>
                                    <div>
                                        <strong>Balconies</strong>
                                        <p><%= property.balconies %></p>
                                    </div>
                                </div>
                            <% } %>
                            <% if (property.floor_number) { %>
                                <div class="spec-item">
                                    <i class="fas fa-layer-group"></i>
                                    <div>
                                        <strong>Floor</strong>
                                        <p><%= property.floor_number %><% if (property.total_floors) { %> of <%= property.total_floors %><% } %></p>
                                    </div>
                                </div>
                            <% } %>
                            <% if (property.furnishing_status) { %>
                                <div class="spec-item">
                                    <i class="fas fa-couch"></i>
                                    <div>
                                        <strong>Furnishing</strong>
                                        <p><%= property.furnishing_status %></p>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                    </div>

                    <% if (property.amenities && property.amenities.length > 0) { %>
                        <div class="property-amenities">
                            <h3>Amenities</h3>
                            <div class="amenities-list">
                                <% property.amenities.forEach(function(amenity) { %>
                                    <span class="amenity-tag"><i class="fas fa-check"></i> <%= amenity %></span>
                                <% }); %>
                            </div>
                        </div>
                    <% } %>

                    <% if (property.description) { %>
                        <div class="property-description">
                            <h3>Description</h3>
                            <p><%= property.description %></p>
                        </div>
                    <% } %>

                    <div class="property-meta">
                        <p><i class="fas fa-eye"></i> <%= property.views || 0 %> views</p>
                        <p><i class="fas fa-calendar"></i> Posted on <%= new Date(property.createdAt).toLocaleDateString('en-IN') %></p>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <aside class="property-sidebar">
                <div class="enquiry-box">
                    <h3>Contact Owner</h3>
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Get in touch with the property owner</p>
                    <form action="/" method="POST" id="enquiryForm">
                        <input type="hidden" name="property_id" value="<%= property.id %>">
                        <div class="form-group">
                            <input type="text" name="name" placeholder="Enter your name" required>
                        </div>
                        <div class="form-group">
                            <input type="email" name="email" placeholder="Enter your email" required>
                        </div>
                        <div class="form-group">
                            <input type="tel" name="phone" placeholder="Enter your phone number" required>
                        </div>
                        <div class="form-group">
                            <textarea name="message" placeholder="Enter your message (optional)" rows="4"></textarea>
                        </div>
                        <button type="submit" class="btn-primary btn-block">Send Enquiry Now</button>
                        <p style="font-size: 11px; color: #999; margin-top: 10px; text-align: center;">By submitting, you agree to our Terms & Conditions</p>
                    </form>
                </div>

                <div class="owner-info">
                    <h3>Property Owner</h3>
                    <% if (property.owner) { %>
                        <div style="margin-bottom: 12px;">
                            <p style="font-weight: bold; margin-bottom: 5px;"><%= property.owner.name %></p>
                            <p style="font-size: 12px; color: #666;">Property Owner</p>
                        </div>
                        <div style="border-top: 1px solid #E0E0E0; padding-top: 12px;">
                            <p style="margin-bottom: 8px;"><i class="fas fa-envelope" style="color: #FF6600; margin-right: 8px;"></i> <%= property.owner.email %></p>
                            <% if (property.owner.phone) { %>
                                <p><i class="fas fa-phone" style="color: #FF6600; margin-right: 8px;"></i> <%= property.owner.phone %></p>
                            <% } %>
                        </div>
                    <% } %>
                </div>

                <div class="action-buttons">
                    <button class="btn-secondary btn-block" onclick="toggleFavorite(<%= property.id %>)" id="favoriteBtn">
                        <i class="fas fa-heart"></i> <span id="favoriteText"><%= isFavorite ? 'Remove from Favorites' : 'Add to Favorites' %></span>
                    </button>
                    <button class="btn-secondary btn-block" onclick="window.print()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </aside>
        </div>

        <!-- Similar Properties -->
        <% if (similarProperties && similarProperties.length > 0) { %>
            <div class="similar-properties">
                <h2>Similar Properties</h2>
                <div class="properties-grid">
                    <% similarProperties.forEach(function(similar) { %>
                        <div class="property-card">
                            <div class="property-image">
                                <% if (similar.images && similar.images.length > 0) { %>
                                    <img src="<%= similar.images[0] %>" alt="<%= similar.title %>">
                                    <% } else { %>
                                        <img src="https://via.placeholder.com/400x300/F97316/FFFFFF?text=No+Image" alt="<%= similar.title %>" style="width: 100%; height: 100%; object-fit: cover;">
                                    <% } %>
                            </div>
                            <div class="property-content">
                                <h3><a href="/properties/<%= similar.id %>"><%= similar.title %></a></h3>
                                <p class="property-location"><i class="fas fa-map-marker-alt"></i> <%= similar.city %></p>
                                <div class="property-price">
                                    <span class="price">₹<%= parseFloat(similar.price).toLocaleString('en-IN') %></span>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </div>
        <% } %>
    </div>
</section>

<script>
function changeImage(imageSrc, index) {
    document.getElementById('mainImage').src = imageSrc;
    // Update active thumbnail
    document.querySelectorAll('.thumbnail-wrapper').forEach((thumb, i) => {
        if (i === index) {
            thumb.classList.add('active');
        } else {
            thumb.classList.remove('active');
        }
    });
}

function toggleFavorite(propertyId) {
    fetch('/properties/favorite', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ property_id: propertyId })
    })
    .then(response => response.json())
    .then(data => {
        const btn = document.getElementById('favoriteBtn');
        const text = document.getElementById('favoriteText');
        if (data.favorited) {
            text.textContent = 'Remove from Favorites';
            btn.classList.add('favorited');
        } else {
            text.textContent = 'Add to Favorites';
            btn.classList.remove('favorited');
        }
    })
    .catch(error => {
        alert('Error updating favorite. Please login first.');
    });
}
</script>

<%- include('partials/footer') %>

